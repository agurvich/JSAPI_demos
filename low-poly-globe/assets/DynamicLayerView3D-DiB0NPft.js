import{fK as v,fL as S,fM as q,fN as W,fO as j,fP as F,I as k,J as M,K as b,v as K,C as Q,w as B,a9 as $,a4 as w,x as J,dy as Y,c3 as O,aU as N,fQ as Z,fR as X,q as H,fS as ee,r as te,fA as ae,fT as C,bo as D,E as L,O as ie,Q as U,fy as re,fU as x,L as se,fV as ne,fW as oe,bn as le,e as y,y as R,c as he}from"./index-O3Mu8AMX.js";import{n as de}from"./LayerView3D-C8CJtSha.js";import{l as ce}from"./projectExtentUtils-Cx8opmom.js";import{T as ue}from"./ImageMaterial.glsl-DtyynWhH.js";import{u as ge}from"./LayerView-CrtEiCUZ.js";import{i as me}from"./RefreshableLayerView-Dqm9uAqk.js";function fe(a,e,t){const i=v(a)/S(a),r={width:t,height:t};return i>1.0001?r.height=t/i:i<.9999&&(r.width=t*i),r.width=Math.round(r.width/(v(a)/v(e))),r.height=Math.round(r.height/(S(a)/S(e))),r}function V(a,e){return q(a,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function pe(a,e,t){if(!W(e,t))return V(a,t);const i=[e[1]-t[1],Math.min(e[3],t[3])-Math.max(e[1],t[1]),t[3]-e[3],123456],r=[e[0]-t[0],Math.min(e[2],t[2])-Math.max(e[0],t[0]),t[2]-e[2],123456],l=t[2]-t[0],n=t[3]-t[1],s=r[0]>0&&r[2]>0?3:2,h=i[0]>0&&i[2]>0?3:2,o=(h+1)*(s+1),c=j(3*o),u=F(2*o),d=new Array(6*(h*s-1));let E=0,A=0,P=0,g=0,f=0;for(let p=0;p<4;p++){const T=i[p];if(T<=0)continue;let I=0;for(let _=0;_<4;_++){const G=r[_];G<=0||(c[A++]=t[0]+I,c[A++]=t[1]+E,c[A++]=-1,u[P++]=I/l,u[P++]=E/n,_<3&&p<3&&(_!==1||p!==1)&&(d[f++]=g,d[f++]=g+1,d[f++]=g+s+1,d[f++]=g+1,d[f++]=g+s+2,d[f++]=g+s+1),g++,I+=G)}E+=T}const z=new Array(d.length);return new k(a,[[M.POSITION,new b(c,d,3,!0)],[M.NORMAL,new b(_e,z,3,!0)],[M.UV0,new b(u,d,2,!0)]])}const _e=[0,0,1];let m=class extends me(de(ge)){constructor(){super(...arguments),this.drapeSourceType=K.RasterImage,this.updatePolicy=Q.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this._drapeSourceRenderer=null,this.refreshDebounced=B(async a=>{this.destroyed||await this._doRefresh(a).catch(e=>{$(e)||w.getLogger(this).error(e)})},2e3)}initialize(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this),this.addHandles(J(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))),this.addResolvingPromise(ce(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",a))),this._updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler()),this.addHandles(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(a,e){this._spatialReference=e,a.forEach((t,i)=>{this._overlays[i]=t,this._updateImageExtent(t,i)})}_updateImageExtent(a,e){const t=this._clippedExtent(a.extent,ye);if(t==null)return;const i=fe(a.extent,t,a.resolution);let r=a.pixelRatio*this.view.state.pixelRatio;const{layer:l}=this;if("imageMaxWidth"in l&&l.imageMaxWidth!=null||"imageMaxHeight"in l&&l.imageMaxHeight!=null){const s=l.imageMaxWidth,h=l.imageMaxHeight;if(i.width>s){const o=s/i.width;i.height=Math.floor(i.height*o),i.width=s,r*=o}if(i.height>h){const o=h/i.height;i.width=Math.floor(i.width*o),i.height=h,r*=o}}const n=this._extents[e];n&&Y(n.extent,t)&&this._imageSizeEquals(t,n.imageSize,i)||(this._extents[e]={extent:O(t),imageSize:i,pixelRatio:r},this.suspended||this._fetch(e).catch(s=>{$(s)||w.getLogger(this).error(s)}))}clear(){for(let a=0;a<this._images.length;a++)this._clearImage(a)}async doRefresh(){return this._doRefresh()}async _doRefresh(a){if(this.suspended)return;const e=[];for(let t=0;t<this._extents.length;t++)this._extents[t]&&e.push(this._fetch(t,a));await Promise.allSettled(e)}canResume(){if(!super.canResume())return!1;const a=this.layer;if(this._isScaleRangeActive()){const{minScale:e,maxScale:t}=a.effectiveScaleRange,i=this.view.scale;if(i<t||e>0&&i>e)return!1}return!0}async processResult(a,e,t){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(a.image=e)}findExtentInfoAt(a){for(const e of this._extents){const t=e.extent;if(new N(t[0],t[1],t[2],t[3],this._spatialReference).contains(a))return e}return null}getFetchOptions(){}async redraw(a,e){await Z(this._images,async(t,i)=>{t&&(await a(t,e),await this._createStageObjects(i,t.image,e))})}_imageSizeEquals(a,e,t){if(!this.maximumDataResolution)return!1;const i=v(a)/this.maximumDataResolution.x,r=S(a)/this.maximumDataResolution.y,l=i/e.width,n=r/e.height,s=i/t.width,h=r/t.height,o=Math.abs(l-s),c=Math.abs(n-h),u=X.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return o<=u&&c<=u}async _fetch(a,e){if(this.suspended)return;const t=this._extents[a],i=t.extent;this._images[a]||(this._images[a]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:O(i)});const r=this._images[a];r.loadingAbortController=H(r.loadingAbortController);const l=new N(i[0],i[1],i[2],i[3],this._spatialReference);if(l.width===0||l.height===0)return void this._clearImage(a);const n=new AbortController;r.loadingAbortController=n,ee(e,()=>n.abort());const s=n.signal,h=this._waitFetchReady(s).then(async()=>{const o={requestAsImageElement:!0,pixelRatio:this._overlays[a].pixelRatio,...this.getFetchOptions(),signal:s},{height:c,width:u}=t.imageSize;return this.layer.fetchImage(l,u,c,o)}).then(o=>{if(te(s))throw w.getLogger(this).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),ae();return this.processResult(r,o)}).then(()=>{C(r.renderExtent,i)});r.loadingPromise=h,await this._updatingHandles.addPromise(h.then(async()=>{D(s),await this._createStageObjects(a,r.image,s)}).catch(o=>{throw o&&!$(o)&&w.getLogger(this).error(o),o}).finally(()=>{h===r.loadingPromise&&(r.loadingPromise=null,r.loadingAbortController=null)}))}_clearImage(a){const e=this._images[a];if(e){e.renderGeometry!=null&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],L.UPDATE),e.renderGeometry=null);const t=this.view._stage,i=e.texture;i==null||i.unload(),t.remove(i),e.texture=null,t.remove(e.material),e.material=null,e.loadingAbortController=H(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(a,e,t){const i=this.view._stage,r=this._images[a],l=()=>{var n;(n=r.texture)==null||n.unload(),i.remove(r.texture),r.texture=null,r.renderGeometry&&(this._drapeSourceRenderer.removeGeometries([r.renderGeometry],L.UPDATE),r.renderGeometry=null)};if(e){const n=new ie(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:U.CLAMP_TO_EDGE,t:U.CLAMP_TO_EDGE}});let s;if(await re(this._images[a===x.INNER?x.OUTER:x.INNER].loadingPromise),D(t),l(),await i.schedule(()=>n.load(i.renderView.renderingContext),t),i.add(n),r.texture=n,r.material==null?(r.material=new ue({transparent:!0,textureId:n.id}),i.add(r.material)):r.material.setParameters({textureId:n.id}),a===x.INNER)s=V(r.material,r.renderExtent);else{const h=this._images[0].renderExtent;if(!h)return void l();s=pe(r.material,h,r.renderExtent)}r.renderGeometry=new se(s),r.renderGeometry.localOrigin=this._overlays[a].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([r.renderGeometry],L.UPDATE)}else l(),i.remove(r.material),r.material=null}_isScaleRangeLayer(){return"effectiveScaleRange"in this.layer}_isScaleRangeActive(){const a=this.layer;if(!this._isScaleRangeLayer())return!1;const{minScale:e,maxScale:t}=a.effectiveScaleRange;return ne(e,t)}_clippedExtent(a,e){if(this.view.viewingMode!=="local")return C(e,a);const t=this.view.basemapTerrain;return t.ready?oe(a,t.extent,e):C(e,a)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(a){await le(()=>this.view.stationary,a),D(a)}};y([R()],m.prototype,"layer",void 0),y([R()],m.prototype,"suspended",void 0),y([R({readOnly:!0})],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),y([R()],m.prototype,"updating",void 0),m=y([he("esri.views.3d.layers.DynamicLayerView3D")],m);const Ae=m,ye=O();export{Ae as N};

import{t as Ve,jR as be,jS as N,jT as $,Q as v,j3 as He,gk as Se,je as Le,k as De,jU as Be,i as Ge,a as Y,jV as Ne,d as _e,P as ze,jW as H,jX as we,u as ve,e7 as We,ik as xe,ja as Je,bC as Xe,jY as qe,jZ as Ye,j_ as Ze,j$ as Ke,R as Te,k0 as Qe,k1 as Z,k2 as et,k3 as tt,a5 as K,iH as Ce,dX as Me,k4 as Pe,k5 as st,gz as it,J as S,k6 as rt,Z as at,bF as nt,k7 as ot,k8 as lt,k9 as Ee,O as ct,jD as dt,jF as ht,jH as ut,jJ as Q,jI as mt,jM as pt,K as L,jO as ft,ka as gt,kb as yt,kc as Oe,kd as Ue,a4 as $e,e as D,y as ee,c as bt,fh as je}from"./index-O3Mu8AMX.js";import{x as _t,f as wt}from"./LayerElevationProvider-CNF2x0ou.js";import{r as P,a as te,S as B,N as O,e as g,m as vt,d as xt,g as se,t as M,n as ie,i as I}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{n as Tt}from"./LayerView3D-C8CJtSha.js";import{s as Ct}from"./RenderTexture-kpEXCKT4.js";import{u as Mt}from"./LayerView-CrtEiCUZ.js";class Pt extends Ve{constructor(e,l,a,d,r,n,m){super(e,0,0,0,l),this.nodesCached=a,this.vboMB=d,this.textureMB=r,this.vboMBCached=n,this.textureMBCached=m}}const Et={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:be.TRIANGLES,[P.TriangleStrip]:be.TRIANGLE_STRIP,[P.NotSet]:null},Ae={[te.Opaque]:N.Opaque,[te.Mask]:N.Mask,[te.Blend]:N.Blend},Ot={[B.Back]:$.Back,[B.Front]:$.Front,[B.None]:$.None,[B.NotSet]:$.Back},Ut={[O.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[O.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[O.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[O.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[O.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},$t={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class jt{constructor(e){this.layerUid=[],this.type=He.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,l,a,d){const r=e.results,n=e.options.store===Se.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const m=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach(b=>{b.visible&&b.intersectionGeometry&&m.intersect(b,a,d,e.tolerance,null,(x,u,f,c)=>{if(u>=0){if(l!=null&&!l(a,d,u))return;const o=s=>{const p=new Be(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));s.set(this.type,p,u,f)};if(this.isGround&&(r.ground.dist==null||u<r.ground.dist)&&o(r.ground),e.options.isFiltered)return;if((r.min.dist==null||u<r.min.dist)&&o(r.min),(r.max.dist==null||u>r.max.dist)&&o(r.max),n){const s=Le(e.ray);o(s),e.results.all.push(s)}}})})}_createTiles3DGraphic(e,l){return new De({layer:e,sourceLayer:e,attributes:l})}}var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));class At{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function G(t){return Math.round(t/1048.576)/1e3}let U=class extends Tt(Mt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Ge.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Y("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=Ne(this).then(e=>{this._intersectionHandler=new jt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,a=>this._slicePlaneEnabledChange(a)),this._elevationProvider=new _t({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const l=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,a=>this._onRemoveFromCache(a));this._memCache=l,this._suspendedHandle=_e(()=>this.suspended,a=>{const d=H(this.view);d&&d.setEnabled(this,!a)},ze),this.addHandles([_e(()=>this.layer.elevationInfo,a=>this._elevationInfoChanged(a))])}).catch(e=>{if(we(this),this._wasmLayerId=-1,e===vt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===xt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),we(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ve(this._memCache),this._updatingHandles=ve(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=We(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const l=this._collection.getMaterial(e);l.commonMaterialParameters.hasSlicePlane=t,l.commonMaterialParameters.cullFace=t?$.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=(t==null?void 0:t.offset)??0,l=t!=null&&t.unit?xe(t==null?void 0:t.unit):1,a=H(this.view);a&&a.setLayerOffset(this,e*l)}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get performanceInfo(){let t=0,e=0,l=0,a=0,d=0,r=0;return this._lyrHandleToObjects.forEach(n=>{n.isVisible?(t+=n.texMemoryUsage,e+=n.vboMemoryUsage,d++):(l+=n.texMemoryUsage,a+=n.vboMemoryUsage,r++)}),new Pt(this.usedMemory,d,r,G(e),G(t),G(a),G(l))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===Je.Local){const l=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(l!==3857&&l!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){var t,e;return(((t=this.layer.elevationInfo)==null?void 0:t.offset)??0)*((e=this.layer.elevationInfo)!=null&&e.unit?xe(this.layer.elevationInfo.unit):1)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new Xe(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=H(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var o;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const l=qe(e.desc.origin),a=new Array,d=new Map,r=new At;r.handle=t.handle,this._lyrHandleToObjects.set(t.handle,r);const n=this.view.basemapTerrain.spatialReference;let m,b;if(this.view.viewingMode==="global"){const s=je();Ye(Ze,l,s,n),m=Ke(Te(),s),b=Qe(Te(),m)}else m=Z,b=Z;const x=je();et(x,x,l);const u=tt(K(),x);let f=null;const c=K();for(let s=0;s<e.desc.prims.length;s++){const p=e.desc.prims[s];if(p.ptype!==P.Lines||e.data==null)continue;const{positionView:h,positionAttr:E,indicesView:T}=this.getBufferViews(p,e.data.buffer,m,!1);E!=null&&h!=null&&T!=null&&(f=Ce(E),Me(c,f.center,l),f.center=c)}for(let s=0;s<e.desc.prims.length;s++){const p=e.desc.prims[s];if(this._dbg(y.VerboseAPI,JSON.stringify(p)),p.ptype===P.Lines)continue;if(Et[p.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+p.ptype+"). Skipping primitive.");continue}const h=(o=e.desc)!=null&&o.materials&&p.materialId!=null?e.desc.materials[p.materialId]:null,E=h!=null?h.lightingModel:se.Unlit,T=E!==se.Unlit,{positionView:_,positionAttr:C,normalsView:Ie,normalsAttr:z,colorAttr:k,texCoord0Attr:R,indicesView:j}=this.getBufferViews(p,e.data.buffer,m,T);if(C==null||_==null||j==null)continue;const re={colors:k!=null,textureCoordinates:R!=null?Pe.Default:Pe.None,hasNormals:Ie!=null,needsNormals:T},ke=C.data.length/C.size,W=(i,w)=>!i||i.data.length/i.size===ke||(this._dbg(y.Error,`${w} !== numPos. Skipping primitive.`),!1);if(!W(R,"numTexcoord")||!W(k,"numColors")||!W(z,"normals"))continue;const ae=st(re);let A;if(f!=null?A=f.clone():(A=Ce(C),Me(c,A.center,l),A.center=c),m!==Z)for(let i=0;i<_.count;i++)_.getVec(i,c),it(c,c,m),_.setVec(i,c);const J=ae.createBuffer(C.data.length),F=new Map([[S.POSITION,C]]);R!=null&&F.set(S.UV0,R),k!=null&&F.set(S.COLOR,k),z!=null&&F.set(S.NORMALCOMPRESSED,z),F.forEach((i,w)=>{i!=null&&rt(w,i,null,null,J,0)});const Re=new Uint32Array([0,j.typedBuffer.length]),Fe={vertices:{data:J.buffer,count:J.byteLength/ae.stride,layoutParameters:re},positionData:{positions:_.typedBuffer,indices:j.typedBuffer},indices:j.typedBuffer,componentOffsets:Re};r.cpuMemoryUsage+=_.count,r.cpuMemoryUsage+=j.count;const ne=this.view.renderSpatialReference,X=K(),q=[1,1,1];wt(u,ne,q,n)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),at(u,ne,X,n);const V=this._collection.createObject({toMapSpace:nt(X[0],X[1],q[0],q[1]),geometry:Fe,obb:A,transform:{position:u,rotationScale:b}});h&&this._collection.updateMaterial(V,i=>{i.baseColor=h.baseColorFactor,i.usePBR=E===se.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(h.baseColorTex,e,d),i.usePBR&&(i.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],i.emissiveFactor=h.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(h.metalTex,e,d),i.emissionTexture=this._getTexture(h.emissiveTex,e,d),i.occlusionTexture=this._getTexture(h.occlusionTex,e,d),i.normalTexture=this._getTexture(h.normalTex,e,d)),i.objectOpacity=0,i.alphaDiscardMode=N.Mask;const w=[];i.baseColorTexture&&w.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&w.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&w.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&w.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&w.push(i.normalTexture.loadPromise);const oe=Promise.all(w);a.push(oe),oe.then(()=>{var le,ce,de,he,ue,me,pe,fe,ge,ye;i.alphaDiscardMode=Ae[h.alphaMode],i.objectOpacity=1,r.texMemoryUsage+=((ce=(le=i.baseColorTexture)==null?void 0:le.glTexture)==null?void 0:ce.usedMemory)||0,i.usePBR&&(r.texMemoryUsage+=((he=(de=i.metallicRoughnessTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,r.texMemoryUsage+=((me=(ue=i.emissionTexture)==null?void 0:ue.glTexture)==null?void 0:me.usedMemory)||0,r.texMemoryUsage+=((fe=(pe=i.occlusionTexture)==null?void 0:pe.glTexture)==null?void 0:fe.usedMemory)||0,r.texMemoryUsage+=((ye=(ge=i.normalTexture)==null?void 0:ge.glTexture)==null?void 0:ye.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=h.isDoubleSided,i.commonMaterialParameters.cullFace=h.faceCulling?Ot[h.faceCulling]:$.Back,this._initialCullFace.set(V,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=ot.All,i.textureAlphaCutoff=h.alphaCutoff??.1,i.alphaDiscardMode=Ae[h.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=lt(this.view.spatialReference)}),r.components.push(V),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(V)}if(await Promise.all(a),d.forEach(s=>{r.textures.push(s)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r,r.totalMemory()),{memUsageBytes:r.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(l=>{this._stage.remove(l)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,l){if(this._memCache){for(let a=0;a<l;++a){const d=t[a],r=e[a];if(!r)continue;const n=this._lyrHandleToObjects.get(d);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(m=>{this._collection.setObjectVisibility(m,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(m))}),this._memCache.pop(`${d}`))}for(let a=0;a<l;++a){const d=t[a],r=e[a];if(r)continue;const n=this._lyrHandleToObjects.get(d);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(m=>{this._collection.setObjectVisibility(m,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(m))}),this._memCache.put(`${d}`,n,n.totalMemory()))}}}_getTexture(t,e,l){var d,r;let a=null;if(t&&((d=e.desc)!=null&&d.images)&&((r=e.data)!=null&&r.buffer)){const n=e.desc.images[t==null?void 0:t.imageId];if(a=l.get(n),!a&&n){const m=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,b=m>1,x=Ut[t.wrapMode??O.None];let u=n.alpha?4:3;const f=new Uint8Array(e.data.buffer,n.data.byteOffset,n.data.byteCount);let c=null,o=null,s=null;switch(n.format){case M.Raw:n.pixelFormat===ie.R8?(c=f.buffer,u=1,o=""):n.pixelFormat===ie.Rgb8?(c=f.buffer,u=3,o=""):n.pixelFormat===ie.Rgba8&&(c=f.buffer,u=4,o="");break;case M.Dxt1:c=f.buffer,u=3,o=Ee.DDS_ENCODING;break;case M.Dxt5:c=f.buffer,u=4,o=Ee.DDS_ENCODING;break;case M.Png:o="image/png",s=document.createElement("img");break;case M.Jpeg:o="image/jpeg",s=document.createElement("img");break;case M.Etc2:o="image/ktx",s=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(s&&o){const p=new Blob([f],{type:o});s.src=URL.createObjectURL(p),c=s}c&&o!=null&&(a=new ct(c,{mipmap:b,maxAnisotropy:m,encoding:o,wrap:x,components:u,noUnpackFlip:!0,width:n.mip0Width,height:n.mip0Height}),this._stage.add(a),l.set(n,a))}}return a?new Ct(this.view._stage.renderView.textureRepository,a.id):null}getBufferViews(t,e,l,a){let d,r,n,m,b,x,u,f=null;for(let c=0;c<t.atrbs.length;c++){const o=t.atrbs[c],s=o.view,p=void 0,h=s.byteOffset+s.byteCount,E=s.byteCount/$t[s.type],T=[...Array(E).keys()].map(_=>_);try{switch(o.sem){case I.Position:s.ncomp!==3||s.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(d=new Q(e,s.byteOffset,p,h),r=new L(d.typedBuffer,T,3));break;case I.Normal:if(s.ncomp!==3||s.type!==g.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else if(a){const _=new Q(e,s.byteOffset,p,h),C=gt(_.typedBuffer,l);b=new yt(C),x=new L(b.typedBuffer,T,2)}break;case I.TexCoord:s.ncomp!==2||s.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):m===void 0&&(m=new L(new ft(e,s.byteOffset,p,h).typedBuffer,T,2));break;case I.Color:s.ncomp===4?(s.type===g.F32&&(f=new dt(e,s.byteOffset,p,h)),s.type===g.U8&&(f=new ht(e,s.byteOffset,p,h)),s.type===g.U16&&(f=new ut(e,s.byteOffset,p,h))):s.ncomp===3&&(s.type===g.F32&&(f=new Q(e,s.byteOffset,p,h)),s.type===g.U8&&(f=new mt(e,s.byteOffset,p,h)),s.type===g.U16&&(f=new pt(e,s.byteOffset,p,h))),f==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):n=new L(f.typedBuffer,T,s.ncomp);break;case I.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+o.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const c=t.index.view,o=void 0,s=c.byteOffset+c.byteCount;switch(t.index.view.type){case g.U16:u=new Ue(e,c.byteOffset,o,s);break;case g.U32:u=new Oe(e,c.byteOffset,o,s);break;case g.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+c.type+").")}}if(u==null&&d!=null){const c=d.count;if(c<65535){const o=new Uint16Array(c);u=new Ue(o)}else{const o=new Uint32Array(c);u=new Oe(o)}for(let o=0;o<c;o++)u.set(o,o)}return{positionView:d,positionAttr:r,colorAttr:n,texCoord0Attr:m,indicesView:u,normalsView:b,normalsAttr:x}}_onRemoveFromCache(t){const e=H(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?$e.getLogger(this).error(e):$e.getLogger(this).warn(e))}};D([ee()],U.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),D([ee()],U.prototype,"layer",void 0),D([ee()],U.prototype,"elevationOffset",null),U=D([bt("esri.views.3d.layers.Tiles3DLayerView3D")],U);const St=U;export{St as default};
